name: Deploy to Cloud Run

on:
  workflow_dispatch:
    inputs:
      application:
        description: "Application to deploy"
        required: true
        type: choice
        options:
          - reader
          - admin
          - search-token-worker
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - stg
      tag:
        description: "Image tag (defaults to git SHA)"
        required: false
        type: string

env:
  REGION: asia-northeast1

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev

      - name: Set deployment variables
        id: vars
        run: |
          TAG="${{ inputs.tag }}"
          if [ -z "${TAG}" ]; then
            TAG="${{ github.sha }}"
          fi
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"

          case "${{ inputs.application }}" in
            reader)
              echo "service_name=stg-lihs-hut" >> "${GITHUB_OUTPUT}"
              echo "dockerfile=applications/frontend/Dockerfile" >> "${GITHUB_OUTPUT}"
              echo "context=applications/frontend" >> "${GITHUB_OUTPUT}"
              echo "app_type=frontend" >> "${GITHUB_OUTPUT}"
              echo "app_name=reader" >> "${GITHUB_OUTPUT}"
              echo "app_port=3000" >> "${GITHUB_OUTPUT}"
              ;;
            admin)
              echo "service_name=stg-lihs-hut-landlord" >> "${GITHUB_OUTPUT}"
              echo "dockerfile=applications/frontend/Dockerfile" >> "${GITHUB_OUTPUT}"
              echo "context=applications/frontend" >> "${GITHUB_OUTPUT}"
              echo "app_type=frontend" >> "${GITHUB_OUTPUT}"
              echo "app_name=admin" >> "${GITHUB_OUTPUT}"
              echo "app_port=3001" >> "${GITHUB_OUTPUT}"
              ;;
            search-token-worker)
              echo "service_name=stg-search-token-worker" >> "${GITHUB_OUTPUT}"
              echo "dockerfile=applications/worker/Dockerfile" >> "${GITHUB_OUTPUT}"
              echo "context=applications/worker" >> "${GITHUB_OUTPUT}"
              echo "app_type=worker" >> "${GITHUB_OUTPUT}"
              echo "app_name=search-token-worker" >> "${GITHUB_OUTPUT}"
              echo "app_port=8080" >> "${GITHUB_OUTPUT}"
              ;;
          esac

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        id: build
        with:
          context: ${{ steps.vars.outputs.context }}
          file: ${{ steps.vars.outputs.dockerfile }}
          push: true
          tags: ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/hut-stg/${{ inputs.application }}:${{ steps.vars.outputs.tag }}
          cache-from: type=gha,scope=${{ inputs.application }}
          cache-to: type=gha,mode=max,scope=${{ inputs.application }}
          build-args: |
            ${{ steps.vars.outputs.app_type == 'frontend' && format('APP_NAME={0}', steps.vars.outputs.app_name) || '' }}
            ${{ steps.vars.outputs.app_type == 'frontend' && format('APP_PORT={0}', steps.vars.outputs.app_port) || '' }}
            ${{ steps.vars.outputs.app_type == 'frontend' && format('NEXT_PUBLIC_FIREBASE_PROJECT_ID={0}', secrets.GCP_PROJECT_ID) || '' }}
            ${{ steps.vars.outputs.app_type == 'frontend' && format('NEXT_PUBLIC_FIREBASE_API_KEY={0}', secrets.FIREBASE_API_KEY) || '' }}
            ${{ steps.vars.outputs.app_type == 'frontend' && format('NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN={0}', secrets.FIREBASE_AUTH_DOMAIN) || '' }}
            ${{ steps.vars.outputs.app_type == 'frontend' && format('NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET={0}', secrets.FIREBASE_STORAGE_BUCKET) || '' }}
            ${{ steps.vars.outputs.app_type == 'frontend' && format('NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID={0}', secrets.FIREBASE_MESSAGING_SENDER_ID) || '' }}
            ${{ steps.vars.outputs.app_type == 'frontend' && format('NEXT_PUBLIC_FIREBASE_APP_ID={0}', secrets.FIREBASE_APP_ID) || '' }}
            ${{ steps.vars.outputs.app_type == 'frontend' && format('SERVER_ACTIONS_ALLOWED_ORIGINS={0}', secrets.SERVER_ACTIONS_ALLOWED_ORIGINS) || '' }}
            ${{ steps.vars.outputs.app_type == 'frontend' && format('IMAGE_REMOTE_PATTERNS={0}', secrets.IMAGE_REMOTE_PATTERNS) || '' }}

      - name: Deploy to Cloud Run
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/hut-stg/${{ inputs.application }}:${{ steps.vars.outputs.tag }}"

          DEPLOY_ARGS=(
            --image "${IMAGE}"
            --port "${{ steps.vars.outputs.app_port }}"
            --region "${REGION}"
            --project "${{ secrets.GCP_PROJECT_ID }}"
          )

          if [ "${{ steps.vars.outputs.app_type }}" = "frontend" ]; then
            DEPLOY_ARGS+=(
              --update-env-vars "NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},NEXT_PUBLIC_USE_FIREBASE_EMULATOR=false"
            )
          fi

          gcloud run services update "${{ steps.vars.outputs.service_name }}" \
            "${DEPLOY_ARGS[@]}"
