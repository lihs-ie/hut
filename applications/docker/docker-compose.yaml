name: hut-firebase-emulator
services:
  firebase-emulator:
    build:
      context: frontend
      dockerfile: Dockerfile
    container_name: hut-firebase-emulator
    ports:
      - "4000:4000" # Emulator UI
      - "8085:8085" # Firestore
      - "9099:9099" # Auth
      - "9199:9199" # Storage
      - "5001:5001" # Functions
      - "9299:9299" # Eventarc
    volumes:
      - ./frontend/data/firestore:/app/data/firestore
      - ./frontend/data/storage:/app/data/storage
      - ./frontend/data/auth:/app/data/auth
      - ./frontend/functions/node_modules:/app/functions/node_modules
    environment:
      - FIREBASE_PROJECT_ID=demo-hut
      - GCLOUD_PROJECT=demo-hut
      - EVENTARC_EMULATOR=localhost:9299
      - PUBSUB_EMULATOR_HOST=pubsub-emulator:8086
    depends_on:
      pubsub-emulator:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  pubsub-emulator:
    image: dipjyotimetia/pubsub-emulator:latest
    container_name: hut-pubsub-emulator
    ports:
      - "8086:8085" # PubSub emulator
    environment:
      - PUBSUB_PROJECT=demo-hut
      - PUBSUB_TOPIC=events
      - PUBSUB_SUBSCRIPTION=events-debug
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  pubsub-ui:
    image: echocode/gcp-pubsub-emulator-ui:latest
    container_name: hut-pubsub-ui
    ports:
      - "8680:8680" # PubSub UI
    environment:
      - PUBSUB_EMULATOR_HOST=pubsub-emulator:8085
      - GCP_PROJECT_IDS=demo-hut
    depends_on:
      pubsub-emulator:
        condition: service_healthy
    restart: unless-stopped

  search-token-worker:
    build:
      context: search-token-worker
      dockerfile: Dockerfile
    container_name: search-token-worker
    working_dir: /var/www/app
    command: sh -c "cabal update && cabal run app"
    ports:
      - "8000:8080"
    environment:
      - FIREBASE_PROJECT_ID=demo-hut
      - FIRESTORE_EMULATOR_HOST=firebase-emulator:8085
      - PUBSUB_EMULATOR_HOST=pubsub-emulator:8085
    volumes:
      - ../search-token-worker:/var/www/app
      - worker-cabal-store:/root/.cabal/store
      - worker-cabal-packages:/root/.cabal/packages
      - worker-dist:/var/www/app/dist-newstyle
      - ~/.config/gcloud/application_default_credentials.json:/root/.config/gcloud/application_default_credentials.json:ro
    depends_on:
      firebase-emulator:
        condition: service_healthy
      pubsub-emulator:
        condition: service_healthy
    restart: unless-stopped

  pubsub-push-init:
    image: curlimages/curl:latest
    container_name: hut-pubsub-push-init
    depends_on:
      pubsub-emulator:
        condition: service_healthy
    entrypoint: ["sh", "-c"]
    command:
      - |
        echo "Waiting for search-token-worker..."
        until curl -sf http://search-token-worker:8080/health > /dev/null 2>&1; do
          sleep 5
        done
        echo "Creating push subscription..."
        curl -s -X PUT "http://pubsub-emulator:8085/v1/projects/demo-hut/subscriptions/events-worker" \
          -H "Content-Type: application/json" \
          -d '{"topic":"projects/demo-hut/topics/events","pushConfig":{"pushEndpoint":"http://search-token-worker:8080/events"}}'
        echo ""
        echo "Push subscription created."
    restart: "no"

volumes:
  worker-cabal-store:
  worker-cabal-packages:
  worker-dist:
